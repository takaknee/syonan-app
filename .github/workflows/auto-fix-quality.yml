name: ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®æ­£

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'ä¿®æ­£å¯¾è±¡ãƒ–ãƒ©ãƒ³ãƒ'
        required: false
        default: 'main'

permissions:
  contents: write
  pull-requests: write
  actions: write

jobs:
  auto-fix-quality:
    name: ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®æ­£
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸš€ Flutterç’°å¢ƒã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.x'
          cache: true
        continue-on-error: true
        timeout-minutes: 3

      - name: ğŸ” Flutteråˆ©ç”¨å¯èƒ½æ€§ã®ç¢ºèª
        id: flutter_check
        run: |
          if command -v flutter >/dev/null 2>&1; then
            echo "flutter_available=true" >> $GITHUB_OUTPUT
            echo "âœ… Flutter ãŒåˆ©ç”¨å¯èƒ½ã§ã™"
            flutter --version
          else
            echo "flutter_available=false" >> $GITHUB_OUTPUT
            echo "âŒ Flutter ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - Flutterå›ºæœ‰ã®ä¿®æ­£ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          fi

      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        if: steps.flutter_check.outputs.flutter_available == 'true'
        run: |
          if [ -f pubspec.yaml ]; then
            echo "ğŸ“¦ Flutterä¾å­˜é–¢ä¿‚ã‚’å–å¾—ä¸­..."
            flutter pub get
          fi
        continue-on-error: true
        timeout-minutes: 3

      - name: ğŸ¨ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£
        if: steps.flutter_check.outputs.flutter_available == 'true'
        id: format_fix
        run: |
          echo "ğŸ”§ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®è‡ªå‹•ä¿®æ­£ä¸­ï¼ˆ120æ–‡å­—åˆ¶é™ï¼‰..."
          
          # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãŒå¿…è¦ã‹ãƒã‚§ãƒƒã‚¯
          if ! dart format --line-length=120 --set-exit-if-changed . --dry-run; then
            echo "format_needed=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸã€‚ä¿®æ­£ã‚’é©ç”¨ä¸­..."
            
            # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’é©ç”¨
            dart format --line-length=120 .
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            if git diff --exit-code; then
              echo "âœ… ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¾Œã«å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
              echo "changes_made=false" >> $GITHUB_OUTPUT
            else
              echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ãŒãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¾ã—ãŸ"
              echo "changes_made=true" >> $GITHUB_OUTPUT
              
              # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¡¨ç¤º
              echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
              git diff --name-only
            fi
          else
            echo "format_needed=false" >> $GITHUB_OUTPUT
            echo "changes_made=false" >> $GITHUB_OUTPUT
            echo "âœ… ã‚³ãƒ¼ãƒ‰ã¯æ—¢ã«é©åˆ‡ã«ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚Œã¦ã„ã¾ã™"
          fi

      - name: Auto-fix analysis issues with precise targeting
        if: steps.flutter_check.outputs.flutter_available == 'true'
        id: analysis_fix
        run: |
          echo "ğŸ” Running analysis and attempting precise auto-fixes..."
          
          # Run analysis and capture output
          if flutter analyze --no-preamble > analysis_output.txt 2>&1; then
            echo "âœ… No analysis issues found"
            echo "analysis_issues=false" >> $GITHUB_OUTPUT
            echo "fixes_applied=false" >> $GITHUB_OUTPUT
          else
            echo "analysis_issues=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Analysis issues detected:"
            cat analysis_output.txt
            
            fixes_applied=false
            
            # Parse analysis output and fix specific issues
            echo "ğŸ¯ Applying precise fixes based on analysis results..."
            
            # Fix prefer_const_constructors issues
            if grep -q "prefer_const_constructors" analysis_output.txt; then
              echo "ğŸ”§ Fixing const constructor issues..."
              
              # Extract file:line information and fix each specific case
              grep "prefer_const_constructors" analysis_output.txt | while IFS= read -r line; do
                # Extract file and line number: file.dart:123:45
                if [[ $line =~ ([^[:space:]]+\.dart):([0-9]+):([0-9]+) ]]; then
                  file="${BASH_REMATCH[1]}"
                  line_num="${BASH_REMATCH[2]}"
                  
                  if [ -f "$file" ]; then
                    echo "  â†’ Fixing const in $file at line $line_num"
                    
                    # Read the specific line and apply const fix
                    current_line=$(sed -n "${line_num}p" "$file")
                    
                    # Smart const addition patterns
                    if [[ $current_line =~ ^([[:space:]]*)([^[:space:]].*)$ ]]; then
                      indent="${BASH_REMATCH[1]}"
                      content="${BASH_REMATCH[2]}"
                      
                      # Common patterns to add const
                      if [[ $content =~ ^(Icon|Text|SizedBox|Padding|Container|MaterialApp|Scaffold)\( ]]; then
                        new_line="${indent}const ${content}"
                        sed -i "${line_num}s/.*/$new_line/" "$file"
                        fixes_applied=true
                        echo "    âœ“ Added const to: $content"
                      elif [[ $content =~ ^([a-zA-Z_][a-zA-Z0-9_]*\() ]]; then
                        # General constructor pattern
                        new_line="${indent}const ${content}"
                        sed -i "${line_num}s/.*/$new_line/" "$file"
                        fixes_applied=true
                        echo "    âœ“ Added const to constructor at line $line_num"
                      fi
                    fi
                  fi
                fi
              done
            fi
            
            # Fix Flutter API compatibility issues
            echo "ğŸ”§ Checking for Flutter API compatibility issues..."
            if grep -q "argument_type_not_assignable" analysis_output.txt; then
              echo "Attempting to fix Flutter API compatibility issues..."
              
              # Fix CardTheme -> CardThemeData (Flutter 3.32+ compatibility)
              if grep -q "CardTheme.*can't be assigned.*CardThemeData" analysis_output.txt; then
                echo "Fixing CardTheme -> CardThemeData compatibility..."
                find lib -name "*.dart" -exec sed -i 's/cardTheme: const CardTheme(/cardTheme: const CardThemeData(/g' {} \; || true
                find lib -name "*.dart" -exec sed -i 's/cardTheme: CardTheme(/cardTheme: CardThemeData(/g' {} \; || true
                fixes_applied=true
              fi
            fi
            
            # Check if any fixes were applied
            if git diff --exit-code; then
              echo "fixes_applied=false" >> $GITHUB_OUTPUT
              echo "â„¹ï¸ No automatic fixes could be applied"
            else
              echo "fixes_applied=true" >> $GITHUB_OUTPUT
              echo "âœ… Some automatic fixes were applied"
              echo "Fixed files:"
              git diff --name-only
            fi
          fi

      - name: Commit auto-fixes
        if: |
          steps.flutter_check.outputs.flutter_available == 'true' && 
          (steps.format_fix.outputs.changes_made == 'true' || steps.analysis_fix.outputs.fixes_applied == 'true')
        run: |
          echo "ğŸ’¾ Committing auto-fixes..."
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          git add -A
          
          commit_message="ğŸ¤– Auto-fix: Code quality improvements"
          
          if [ "${{ steps.format_fix.outputs.changes_made }}" = "true" ]; then
            commit_message="$commit_message - Format code"
          fi
          
          if [ "${{ steps.analysis_fix.outputs.fixes_applied }}" = "true" ]; then
            commit_message="$commit_message - Fix analysis issues"
          fi
          
          git commit -m "$commit_message" || echo "No changes to commit"

      - name: ğŸ“¤ å¤‰æ›´ã®ãƒ—ãƒƒã‚·ãƒ¥
        if: |
          steps.flutter_check.outputs.flutter_available == 'true' && 
          (steps.format_fix.outputs.changes_made == 'true' || steps.analysis_fix.outputs.fixes_applied == 'true')
        run: |
          echo "ğŸ“¤ è‡ªå‹•ä¿®æ­£ã‚’ãƒ—ãƒƒã‚·ãƒ¥ä¸­..."
          git push origin HEAD

      - name: ğŸ“ PRçµæœã‚³ãƒ¡ãƒ³ãƒˆã®æŠ•ç¨¿
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const flutterAvailable = '${{ steps.flutter_check.outputs.flutter_available }}';
            const formatNeeded = '${{ steps.format_fix.outputs.format_needed }}';
            const changesMade = '${{ steps.format_fix.outputs.changes_made }}';
            const analysisIssues = '${{ steps.analysis_fix.outputs.analysis_issues }}';
            const fixesApplied = '${{ steps.analysis_fix.outputs.fixes_applied }}';
            
            let comment = '## ğŸ¤– ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®æ­£ã®çµæœ\n\n';
            
            if (flutterAvailable === 'false') {
              comment += 'âš ï¸ Flutterç’°å¢ƒãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - å“è³ªãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ\n';
            } else {
              comment += '### ğŸ“ ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ\n';
              if (formatNeeded === 'true') {
                if (changesMade === 'true') {
                  comment += 'âœ… **ä¿®æ­£å®Œäº†**: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡ŒãŒè‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã—ãŸ\n';
                } else {
                  comment += 'âœ… **æ­£å¸¸**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã¯æ—¢ã«æ­£ã—ã„çŠ¶æ…‹ã§ã—ãŸ\n';
                }
              } else {
                comment += 'âœ… **æ­£å¸¸**: ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®å•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n';
              }
              
              comment += '\n### ğŸ” ã‚³ãƒ¼ãƒ‰è§£æ\n';
              if (analysisIssues === 'true') {
                if (fixesApplied === 'true') {
                  comment += 'âœ… **ä¸€éƒ¨ä¿®æ­£å®Œäº†**: ã„ãã¤ã‹ã®è§£æå•é¡ŒãŒè‡ªå‹•ä¿®æ­£ã•ã‚Œã¾ã—ãŸ\n';
                  comment += 'âš ï¸ æ®‹ã‚Šã®å•é¡Œã«ã¤ã„ã¦ã¯æ‰‹å‹•ã§ã®ç¢ºèªãŒå¿…è¦ã§ã™\n';
                } else {
                  comment += 'âš ï¸ **æ‰‹å‹•ä¿®æ­£ãŒå¿…è¦**: æ‰‹å‹•å¯¾å¿œãŒå¿…è¦ãªè§£æå•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n';
                }
              } else {
                comment += 'âœ… **æ­£å¸¸**: è§£æå•é¡Œã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ\n';
              }
              
              if (changesMade === 'true' || fixesApplied === 'true') {
                comment += '\n---\n';
                comment += 'âœ¨ **è‡ªå‹•ä¿®æ­£ãŒé©ç”¨ã•ã‚Œã€ã“ã®PRã«ã‚³ãƒŸãƒƒãƒˆã•ã‚Œã¾ã—ãŸ**\n';
                comment += 'å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã€è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ã‚‹ã‹ã”ç¢ºèªãã ã•ã„ã€‚\n';
              }
            }
            
            comment += '\n---\n';
            comment += '*ã“ã®ã‚³ãƒ¡ãƒ³ãƒˆã¯ã‚³ãƒ¼ãƒ‰å“è³ªè‡ªå‹•ä¿®æ­£ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fallback quality check (without Flutter)
        if: steps.flutter_check.outputs.flutter_available == 'false'
        run: |
          echo "ğŸ” Running basic quality checks without Flutter..."
          
          # Basic file structure checks
          echo "ğŸ“‚ Checking project structure..."
          if [ -f pubspec.yaml ]; then
            echo "âœ… pubspec.yaml found"
          else
            echo "âŒ pubspec.yaml not found"
          fi
          
          if [ -d lib ]; then
            echo "âœ… lib directory found"
            echo "Dart files in lib: $(find lib -name "*.dart" | wc -l)"
          else
            echo "âŒ lib directory not found"
          fi
          
          if [ -d test ]; then
            echo "âœ… test directory found"
            echo "Test files: $(find test -name "*_test.dart" | wc -l)"
          else
            echo "âš ï¸ test directory not found"
          fi
          
          # Basic syntax checks using basic tools
          echo "ğŸ“ Basic syntax validation..."
          find lib test -name "*.dart" 2>/dev/null | head -10 | while read file; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              # Basic syntax check - just ensure file is readable
              cat "$file" > /dev/null && echo "  âœ… Readable" || echo "  âŒ Issue with file"
            fi
          done
          
          echo "âœ… Basic quality checks completed"
